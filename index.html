<html>
    <head>
        <script type="text/javascript">
            var bzURL = "";
	    var sessionToken = "";
            var bzProduct = "";
            var bzProductMilestone = ""
            var bzComponent = ""
            var bzPriority = ""
            var bzAssignedTo = ""
            var bzOrder = "priority"

            //window.onload = loadBoard;
	    function doSubmit() {		
		bzURL = document.getElementById('textURL').value;
		document.getElementById("board-headings").innerHTML = "";
		document.getElementById("board-cards").innerHTML = "";
		loadBoard();
	    }	

            function loadBoard() {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        var obj = JSON.parse(response);
                        statuses = obj.values;
                        for (var key in statuses) {
                            status = statuses[key];
                            addBoardColumn(status);
                        }


                        loadBugs();
                    }
                }
                xhr.open("GET", bzURL + "/rest/field/bug/status/values");
                xhr.send();
            }

            function loadBugs() {
		bzProduct = document.getElementById('textProduct').value;
		bzProductMilestone = document.getElementById('textMilestone').value;
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        var obj = JSON.parse(response);
                        bugs = obj.bugs;
                        for (var key in bugs) {
                            bug = bugs[key];
                            addCard(bug);
                        }
                    }
                }
                xhr.open("GET", bzURL + "/rest/bug?product=" + bzProduct + "&include_fields=summary,status,id,severity,priority&order=" + bzOrder + "&target_milestone=" + bzProductMilestone + "&component=" + bzComponent + "&priority=" + bzPriority + "&assigned_to=" + bzAssignedTo);
                xhr.send();
            }

            function addBoardColumn(status) {
                var th = document.createElement('th');
                th.innerHTML = status;
                document.getElementById("board-headings").appendChild(th);

                var td = document.createElement('td');
                td.id = status;
                document.getElementById("board-cards").appendChild(td);
            }

            function addCard(bug) {
                var div = document.createElement('div');
                div.className = bug.severity + " " + bug.priority +" " + "card";
                div.innerHTML = "<a href='" + bzURL + "/show_bug.cgi?id=" + bug.id + "'>#" + bug.id + "</a> " + bug.summary;
                document.getElementById(bug.status).appendChild(div);
            }

            function doAuth(user, password) {
      		var buttonState = "";
		bzURL = document.getElementById('textURL').value;
      		buttonState = document.getElementById("btnLogin").innerHTML;
      	
      		if (buttonState == "Log In") {
      			var apiURL = bzURL + "/rest/login?login=" + user + "&password=" + password
      			var client = new XMLHttpRequest();
      			client.onreadystatechange = progressListener("login");
      			client.open("GET", apiURL);
      			client.setRequestHeader('Accept',       'application/json');
      			client.setRequestHeader('Content-Type', 'application/json');
      			client.send();
      
			} else {
			// Logged in already, so log out
			var apiURL = bzURL + "/rest/logout?token=" + sessionToken
			var client = new XMLHttpRequest();
			client.onreadystatechange = progressListener();
			client.open("GET", apiURL);
			client.setRequestHeader('Accept',       'application/json');
			client.setRequestHeader('Content-Type', 'application/json');
			client.send();
			}
			if (this.status == 401) {
				alert("failed login attempt");
			}
			if (buttonState == "Log In") {
				// UI changes so user knows logged in
				document.getElementById("credentials").disabled = true;
				document.getElementById("credentials").style.visibility='hidden';
				document.getElementById("btnLogin").innerHTML="Log Out";
			} else if (buttonState == "Log Out") {
				// UI changes so user knows logged in
				document.getElementById("credentials").disabled = false;
				document.getElementById("credentials").style.visibility='visible';
				document.getElementById("btnLogin").innerHTML="Log In";
			}
      	    }

	    function handleResponse(response) {
	    	var output = "";
	    	var json = JSON.parse(response);
	    	// debug
	    	//console.log(json.token);
	    	sessionToken = json.token;
	    }

	    function progressListener() {
		if (this.readyState == 4 && this.status == 200) {
			handleResponse(this.responseText);
		}
	    }

        </script>
        <style>
            body {
                background-color: ghostwhite;
            }
            #board {
                width: 100%;
                table-layout: fixed;
            }
            .card {
                background-color: white;
                border-width: 1px;
                border-color: black;
                border-style: dotted;
                padding: 5px;
                margin: 2px;
            }
            .enhancement {
                border-right-color: greenyellow;
                border-right-width: 4px;
                border-right-style: solid;
            }
            .critical {
                border-right-color: red;
                border-right-width: 4px;
                border-right-style: solid;
            }
            .P1 {
                border-left-color: orange;
                border-left-width: 4px;
                border-left-style: solid;
            }
            #board-cards {
                vertical-align: top;
            }
	    #input {
		width: 100%;
	    }
        </style>
    </head>
    <body>
	<form id="credentials">
		Username:<input type="text" name="login" value=""></br>
		Password:<input type="password" name="password" value=""></br>
	</form>
	</br>
	<form id="input">
		<button type="button" id="btnLogin" onclick="doAuth(document.getElementsByName('login')[0].value, document.getElementsByName('password')[0].value)">Log In</button>
		</br>
		Site URL:<input type="text" id="textURL" value="http://bugzilla.ddk.armysimulation.mil.ca" style="width:250px;"></br>
		Product:<input type="text" id="textProduct" value=""></br>
		Milestone:<input type="text" id="textMilestone" value=""></br>
		<button type="button" id="btnSubmit" onclick="doSubmit()">Submit</button>
	</form>
        <table id="board">
            <tr id="board-headings"></tr>
            <tr id="board-cards"></tr>
        </table>
    </body>
</html>
