<html>
    <head>
        <title>Bz Kanban Board</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

        <style>
            body {
                background-color: lightsteelblue;
                background: linear-gradient(to bottom, rgba(207,231,250,1) 0%,rgba(99,147,193,1) 100%);
                font-family: sans-serif;
                margin: 0;
                display: flex;
                height: 100%;
                flex-direction: column;
            }
            #board {
                width: 100%;
                display: flex;
                padding-top: 20px;
            }
            .board-column-title {
                text-align: center;
                font-weight: bold;
                align-items: center;
                display: flex;
                justify-content: center;
            }
            .board-column-card-count {
                font-size: small;
                color: grey;
                margin-left: 10px;
            }
            .board-column {
                flex: 1;
                vertical-align: top;
                min-width: 0;
                overflow-y: auto;
                overflow-x: hidden;
                flex-wrap: wrap;
            }
            .board-column.drag-card {
                outline-width: 2px;
                outline-style: dashed;
                outline-color: grey;
            }
            .card {
                background-color: white;
                border-width: 1px;
                border-color: grey;
                border-style: solid;
                border-radius: 5px;
                padding: 10px;
                margin: 3px;
                font-size: small;
            }
            .card:hover {
                background-color: ghostwhite;
                border-color: black;
            }
            .card-ref {
                font-size: smaller;
            }
            .card-summary {
                padding-top: 5px;
            }
            .card-meta {
                font-size: smaller;
                color: grey;
                padding: 1px;
                margin-top: 15px;
            }
            .card-meta .assignee {
                float: right;
            }
            .card-meta .assignee img#picture{
                margin-left: 5px;
                vertical-align: bottom;
            }
            .card-meta #icons {
                float: initial;
            }
            .card-meta #deadline {
                margin-right: 5px;
            }
            .card-meta #comment {
                margin-right: 5px;
            }
            .card-meta #severity {
                border-radius: 3px;
                border-width: 1px;
                border-style: solid;
                margin-right: 5px;
                padding: 1px;
            }
            .card-meta #severity[data-severity='blocker'],
            .card-meta #severity[data-severity='critical'],
            .card-meta #severity[data-severity='major'] {
                color: red;
            }
            .card-meta #severity[data-severity='normal'],
            .card-meta #severity[data-severity='minor'],
            .card-meta #severity[data-severity='trivial'] {
                color: gray;
            }
            .card-meta #severity[data-severity='enhancement'] {
                color: green;
            }
            .card-meta #priority {
                border-radius: 3px;
                border-width: 1px;
                border-style: solid;
                margin-right: 5px;
                padding: 1px;
            }
            .card-meta #priority[data-priority='P1'],
            .card-meta #priority[data-priority='Highest'] {
                color: red;
            }
            .card-meta #priority[data-priority='P2'],
            .card-meta #priority[data-priority='High'] {
                color: orange;
            }
            .card-meta #priority[data-priority='P3'],
            .card-meta #priority[data-priority='Normal'],
            .card-meta #priority[data-priority='normal'],
            .card-meta #priority[data-priority='---'] {
                color: green;
            }
            fieldset {
                border-width: 0;
            }
            #textBacklog {
                width: 100px;
                height: 40px;
                border-style: solid;
                border-color: white;
                border-width: thin;
                text-align: center;
                align-self: center;
                display: none;
                font-size: small;
                margin-left: 15px;
            }
            #queryForm {
                display: inline-block;
                padding-top: 20px; /* To line up with login button */
            }
            #queryForm .fa {
                vertical-align: middle;
            }
            #queryForm select {
                width: 150px;
            }
            #queryForm fieldset span {
                margin-right: 15px;
            }
            #loginForm {
                display: none;
            }
            .priority,
            .severity,
            .resolution {
                background: darkgray;
                color: black;
                text-align: -webkit-center;
                border: thin solid black;
                margin-top: 10px;
                padding: 10px;
                margin: 5px;
                font-size: small;
            }
            #title {
                background: none;
                font-weight: bold;
                border: none;
                display: inline;
            }
            .drop-target-hover {
                background: gold;
            }
            #notification {
                display: none;
            }
            #nav {
                flex: none;
                display: flex;
                flex-wrap: wrap;
                padding: 5px;
                border-bottom-width: 1px;
                border-bottom-style: solid;
                border-bottom-color: ghostwhite;
            }
            #nav span {
                align-self: center;
            }
            #nav .spring {
                flex: 1;
            }
            #spinner {
                padding: 5px;
            }
        </style>
    </head>
    <body>
        <div id="nav">
            <form id="queryForm" action="index.html" method="get">
                <fieldset>
                    <span>
                        <i class="fa fa-archive"></i>
                        <select id="textProduct" name="product" placeholder="Product"></select>
                    </span>
                    <span>
                        <i class="fa fa-flag"></i>
                        <select id="textMilestone" name="milestone" placeholder="Milestone"></select>
                    </span>
                    <span>
                        <i class="fa fa-user"></i>
                        <select id="textAssignee" name="assignee" placeholder="Assignee Email" disabled></select>
                    </span>
                    <span style="display:none;">
                        <input type="text" id="textSiteURL" name="site"></input>
                    </span>
                    <span style="display:none;">
                        <input type="text" id="textComments" name="comments"></input>
                    </span>
                    <span style="display:none;">
                        <input type="text" id="textAutoComment" name="autocomment"></input>
                    </span>
                    <span style="display:none;">
                        <input type="text" id="textGravatar" name="gravatar"></input>
                    </span>
                    <button type="submit" id="btnSubmit">Submit</button>
                </fieldset>
            </form>
            <div id="textBacklog" class="drop-target" ondragenter="return dragCardEnter(event)" ondrop="return dropBacklog(event)" ondragover="return dragCardOver(event)" ondragleave="return dragCardLeave(event)">Backlog</div>
            <form id="loginForm">
                <fieldset>
                    <legend>Login</legend>
                    <span>
                        <label for="textUserName">Username</label>
                        <input type="text" required id="textUsername" name="username" value="">
                    </span>
                    <span>
                        <label for="textPassword" >Password</label>
                        <input type="password" required id="textPassword" name="password" value="">
                    </span>
                    <input type="button" id="btnAuthSubmit" value="Submit">
                </fieldset>
            </form>
            <span class="spring"></span>
            <span id="spinner"></span>
            <span id="actions">
                <button id="btnCreate">New Bug</button>
                <span id="whoami"></span>
                <button id="btnSignIn">Login</button>
                <i id="notification" class="fa fa-bell"></i>
            </span>
        </div>
        <div id="board">
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/md5.js"></script>
        <script type="text/javascript">
            var bzComponent = "";
            var bzPriority = "";
            var bzAssignedTo = "";
            var bzOrder = "priority,bug_severity,assigned_to";
            var bzSiteUrl = "http://bugzilla.msec.local";
            var userFullName = "";
            var userGravatar = true;
            var bzProduct = "";
            var bzProductMilestone = "";
            var bzBoardLoadTime = "";
            var bzRestGetBugsUrl = "";
            var shouldCheckForUpdates = true;
            var shouldLoadComments = true;
            var shouldAutoComment = false;
            var assignees = new Map();
            var defaultPriority;
            var defaultSeverity;
            var defaultMilestone;
            var authObject;

            window.onload = loadParams;

            function loadParams() {
                bzProduct = getURLParameter('product');
                bzProductMilestone = getURLParameter('milestone');
                bzAssignedTo = getURLParameter('assignee');

                // Allow the Bugzilla site URL to be overriden. Useful for testing.
                // For most permanent deployments just change the hardcodecoded bzSiteUrl.
                var site = getURLParameter('site');
                if (site != null) {
                    bzSiteUrl = site;
                    document.getElementById("textSiteURL").value = bzSiteUrl;
                }

                authObject = JSON.parse(localStorage.getItem(bzSiteUrl));

                // Loading comments is expensive becase it's one extra request per bug.
                // Causing some Bugzilla servers to respond with "too many requests" errors.
                var comments = getURLParameter('comments');
                if (comments != null) {
                    shouldLoadComments = isTrue(comments);
                    document.getElementById("textComments").value = shouldLoadComments;
                }

                var autocomment = getURLParameter('autocomment');
                if (autocomment != null) {
                    shouldAutoComment = isTrue(autocomment);
                    document.getElementById("textAutoComment").value = shouldAutoComment;
                }

                var pictures = getURLParameter('gravatar');
                if (pictures != null) {
                    userGravatar = isTrue(pictures);
                    document.getElementById("textGravatar").value = pictures;
                }

                if (isLoggedIn()) {
                    loadName();
                    hideSignInButton();
                }

                // Disable input fields until response is complete.
                // Having the user keep clicking the drop down isn't nice.
                document.getElementById("textProduct").disabled = true;
                document.getElementById("textMilestone").disabled = true;

                loadProductsList();

                document.getElementById("textAssignee").value = bzAssignedTo
            }

            function loadBoard() {
                showSpinner();
                httpGet("/rest/field/bug/status/values", function(response) {
                    clearBoard();
                    var statuses = response.values;
                    for (var key in statuses) {
                        status = statuses[key];
                        addBoardColumn(status);
                    }
                    // Hide UNCONFIRMED column if product has disabled it.
                    // But, product name may not have been provided if querying only on email.
                    if (bzProduct != null) {
                        httpGet("/rest/product/" + bzProduct + "?include_fields=has_unconfirmed", function(response) {
                            if (!(response.products[0].has_unconfirmed)) {
                                document.getElementsByClassName("board-column").UNCONFIRMED.hidden = true;
                            }
                        });
                    }
                    loadBugs();
                    if (isLoggedIn()) {
                        loadResolutions();
                        loadPriorities();
                        loadSeverities();
                        loadDefaultPrioritySeverity();
                        loadDefaultMilestone();
                    }
                });
            }

            function loadBugs() {
                bzProduct = document.getElementById('textProduct').value;
                bzProductMilestone = document.getElementById('textMilestone').value;
                bzAssignedTo = document.getElementById('textAssignee').value;
                bzBoardLoadTime = new Date().toISOString();

                bzRestGetBugsUrl = "/rest/bug?product=" + bzProduct;
                bzRestGetBugsUrl += "&include_fields=summary,status,id,severity,priority,assigned_to,last_updated,deadline";
                bzRestGetBugsUrl += "&order=" + bzOrder;
                bzRestGetBugsUrl += "&target_milestone=" + bzProductMilestone;
                bzRestGetBugsUrl += "&component=" + bzComponent;
                bzRestGetBugsUrl += "&priority=" + bzPriority;
                bzRestGetBugsUrl += "&assigned_to=" + bzAssignedTo;

                httpGet(bzRestGetBugsUrl, function(response) {
                    var bugs = response.bugs;

                    for (var key in bugs) {
                        bug = bugs[key];
                        addCard(bug);
                    }
                    showColumnCounts();
                    loadAssigneesList();
                    hideSpinner();
                    scheduleCheckForUpdates();
                });

            }

            function loadProductsList() {
                httpGet("/rest/product?type=enterable&include_fields=name", function(response) {
                    document.getElementById("textProduct").disabled = false;
                    var products = response.products;
                    products.sort(function(a, b) {
                        return a.name.localeCompare(b.name);
                    });
                    for (var key in products) {
                        var product = products[key];
                        var option = document.createElement('option');
                        option.value = product.name;
                        option.text = product.name;
                        document.getElementById("textProduct").appendChild(option);
                    }
                    // select it in list.
                    document.getElementById("textProduct").value = bzProduct;
                    if (bzProduct != null) {
                        loadMilestonesList();
                    }
                });
            }

            function loadMilestonesList() {
                bzProduct = document.getElementById("textProduct").value;
                clearMilestonesList();
                httpGet("/rest/product?names=" + bzProduct + "&include_fields=milestones", function(response) {
                    document.getElementById("textMilestone").disabled = false;
                    var milestones = response.products[0].milestones;
                    for (var key in milestones) {
                        var milestone = milestones[key];
                        var option = document.createElement('option');
                        option.value = milestone.name;
                        option.text = milestone.name;
                        document.getElementById("textMilestone").appendChild(option);
                    }
                    // select it in list.
                    document.getElementById("textMilestone").value = bzProductMilestone;
                    if (bzProduct != "" && bzProductMilestone != "") {
                        loadBoard();
                    }
                });
            }

            function loadAssigneesList() {
                // HACK add phony user so that we can show all users
                assignees.set( "", { real_name: "ALL", email: "" });

                var sorted = Array.from(assignees.values()).sort(function(a, b) {
                    return a.real_name.localeCompare(b.real_name);
                });

                var elem = document.getElementById("textAssignee");

                sorted.forEach(function(assignee) {
                    var option = document.createElement('option');
                    option.value = assignee.email;
                    option.text = assignee.real_name;
                    elem.appendChild(option);
                });

                elem.removeAttribute("disabled");
            }

            function loadComments(bug) {
                httpGet("/rest/bug/" + bug.id + "/comment?include_fields=id", function(response) {
                    var card = getCardElement(bug.id);
                    var commentCount = response.bugs[bug.id].comments.length - 1;
                    if (commentCount > 1) {
                        var commentElement = card.children.cardmeta.children.icons.children.comment;
                        commentElement.style.display = null; // unhide it

                        var icon = document.createElement('i');
                        icon.setAttribute("class", "fa fa-comment-o fa-sm");
                        icon.style.marginRight = "4px";

                        commentElement.appendChild(icon);
                        commentElement.appendChild(document.createTextNode(commentCount));
                    }
                });
            }

            function loadName() {
                httpGet("/rest/user/" + authObject.userID + "?token=" + authObject.userToken, function(response) {
                    userFullName = response.users[0].real_name;
                    if (userFullName != null) {
                        document.getElementById("whoami").textContent = userFullName;
                    }
                });
            }

            function loadResolutions() {
                httpGet("/rest/field/bug/resolution", function(response) {
                    var arrayResolutions = response.fields;

                    var resolutions = document.createElement("div");
                    resolutions.className = "resolutions";
                    resolutions.hidden = true;

                    var labelbox = document.createElement("div");
                    labelbox.className = "resolution";
                    labelbox.innerText += arrayResolutions[0].display_name;
                    labelbox.id = "title";
                    resolutions.appendChild(labelbox);

                    for (var i = 0;  i < arrayResolutions[0].values.length; i++) {
                        var resolutionName = arrayResolutions[0].values[i].name;
                        if (resolutionName != "") {
                            var box = document.createElement("div");
                            box.className = "resolution drop-target";
                            box.innerText += resolutionName;
                            box.id = resolutionName;
                            resolutions.appendChild(box);
                        }
                    }

                    // FIXME: this assumes the column name, but it may have been renamed by the bz instance.
                    document.getElementById("RESOLVED").appendChild(resolutions);
                });
            }

            function loadPriorities() {
                httpGet("/rest/field/bug/priority", function(response) {
                    // FIXME: this assumes the column name, but it may have been renamed by the bz instance.
                    var columns = ["CONFIRMED", "IN_PROGRESS"];

                    for (var title = 0; title < columns.length; title++) {
                        var arrayPriorities = response.fields;

                        var priorities = document.createElement("div");
                        priorities.className = "priorities";
                        priorities.hidden = true;

                        var labelbox = document.createElement("div");
                        labelbox.className = "priority";
                        labelbox.innerText += arrayPriorities[0].display_name;
                        labelbox.id = "title";
                        priorities.appendChild(labelbox);

                        for (var i = 0;  i < arrayPriorities[0].values.length; i++) {
                            var priorityName = arrayPriorities[0].values[i].name;
                            if (priorityName != "") {
                                var box = document.createElement("div");
                                box.className = "priority drop-target";
                                box.innerText += priorityName;
                                box.id = priorityName;
                                priorities.appendChild(box);
                            }
                        }

                        document.getElementById(columns[title]).appendChild(priorities);
                    }
                });
            }

            function loadSeverities() {
                httpGet("/rest/field/bug/bug_severity", function(response) {
                    // FIXME: this assumes the column name, but it may have been renamed by the bz instance.
                    var columns = ["CONFIRMED", "IN_PROGRESS"];

                    for (var title = 0; title < columns.length; title++) {
                        var arraySeverities = response.fields;

                        var severities = document.createElement("div");
                        severities.className = "severities";
                        severities.hidden = true;

                        var labelbox = document.createElement("div");
                        labelbox.className = "severity";
                        labelbox.innerText += arraySeverities[0].display_name;
                        labelbox.id = "title";
                        severities.appendChild(labelbox);

                        for (var i = 0;  i < arraySeverities[0].values.length; i++) {
                            var severityName = arraySeverities[0].values[i].name;
                            if (severityName != "") {
                                var box = document.createElement("div");
                                box.className = "severity drop-target";
                                box.innerText += severityName;
                                box.id = severityName;
                                severities.appendChild(box);
                            }
                        }

                        document.getElementById(columns[title]).appendChild(severities);
                    }
                });
            }

            function loadCheckForUpdates() {
                if (bzBoardLoadTime == "") {
                    shouldCheckForUpdates = false;
                    return;
                }
                httpGet(bzRestGetBugsUrl + "&last_change_time=" + bzBoardLoadTime, function(response) {
                    if (response.bugs.length > 0) {
                        var bell = document.getElementById("notification");
                        bell.style.display = "inline";
                        bell.title = response.bugs.length + " bug(s) have been updated externally. Hit refresh!";
                    }

                    if (shouldCheckForUpdates) {
                        // Repeat.
                        scheduleCheckForUpdates();
                    }
                });
            }

            function loadDefaultPrioritySeverity() {
                httpGet("/rest/parameters?token=" + authObject.userToken, function(response) {
                    defaultPriority = response.parameters.defaultpriority;
                    defaultSeverity = response.parameters.defaultseverity;
                });
            }

            function loadDefaultMilestone() {
                httpGet("/rest/product/" + bzProduct + "?type=enterable&include_fields=default_milestone", function(response) {
                    defaultMilestone = response.products[0].default_milestone;
                });
            }

            function showBacklog(state) {
                if (state) {
                    document.getElementById("textBacklog").style.display = "inline-block";
                } else {
                    document.getElementById("textBacklog").style.display = "none";
                }
            }

            function addBoardColumn(status) {
                var div = document.createElement('div');
                div.className = "board-column";
                div.id = status;
                if (isLoggedIn()) {
                    div.addEventListener('drag', dragCardStart);
                    div.addEventListener('dragend', dragCardEnd);
                    div.addEventListener('dragover', dragCardOver);
                    div.addEventListener('drop', dropCard);
                    div.addEventListener('dragenter', dragCardEnter);
                    div.addEventListener('dragleave', dragCardLeave);
                }
                document.getElementById("board").appendChild(div);

                var title = document.createElement('div');
                title.className = "board-column-title";
                title.innerHTML = status;
                document.getElementById(status).appendChild(title);

            }

            function addCard(bug) {
                var card = document.createElement('div');
                card.className = "card";
                card.dataset.bugId = bug.id;

                var buglink = document.createElement('a');
                buglink.href= bzSiteUrl + "/show_bug.cgi?id=" + bug.id;
                buglink.innerHTML = "#" + bug.id;
                buglink.className = "card-ref";

                var summary = document.createElement('div');
                summary.appendChild(document.createTextNode(bug.summary)); // so that we get HTML string escaping for free
                summary.className = "card-summary";

                var meta = document.createElement('div');
                meta.className = "card-meta";
                meta.setAttribute("id", "cardmeta");

                var assignee = document.createElement('span');
                assignee.className = "assignee";

                var fullname = document.createElement('span');
                fullname.className = "fullname";
                fullname.innerHTML = bug.assigned_to_detail.real_name;

                var picture = document.createElement('img');
                picture.setAttribute("id", "picture");
                if (userGravatar) {
                    picture.src = getPictureSrc(bug.assigned_to_detail.email);
                } else {
                    hidePicture(picture);
                }

                var icons = document.createElement('span');
                icons.setAttribute("id", "icons");

                var comment = document.createElement('span');
                comment.setAttribute("id", "comment");
                comment.style.display = "none";

                var deadline = createDeadlineElement(bug.deadline);

                var priority = document.createElement('span');
                priority.setAttribute("id", "priority");
                priority.innerHTML = bug.priority;
                priority.dataset.priority = bug.priority;

                var severity = document.createElement('span');
                severity.setAttribute("id", "severity");
                severity.innerHTML = bug.severity;
                severity.dataset.severity = bug.severity;

                card.appendChild(buglink);
                card.appendChild(summary);
                card.appendChild(meta);
                meta.appendChild(icons);
                icons.appendChild(priority);
                icons.appendChild(severity);
                icons.appendChild(comment);
                icons.appendChild(deadline);
                assignee.appendChild(fullname);
                assignee.appendChild(picture);
                meta.appendChild(assignee);

                if (isLoggedIn()) {
                    card.draggable = "true";
                    card.addEventListener('dragstart', dragCard);
                }

                if (shouldLoadComments) {
                    loadComments(bug);
                }

                document.getElementById(bug.status).appendChild(card);

                assignees.set(bug.assigned_to_detail.email, bug.assigned_to_detail); // save for later
            }

            function createDeadlineElement(deadline) {
                var deadlineElement = document.createElement('span');
                deadlineElement.setAttribute("id", "deadline");

                if (deadline == undefined || deadline == null) {
                    deadlineElement.style.display = "none";
                    return deadlineElement;
                }

                var month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"];
                var todayDate = Date.now();
                var cardDate = new Date();
                var dateArray = deadline.split('-');
                cardDate.setFullYear(dateArray[0], dateArray[1] - 1, dateArray[2]);

                var icon = document.createElement('i');
                icon.setAttribute("class", "fa fa-calendar-o fa-sm");
                icon.style.marginRight = "4px";

                var dateText = document.createTextNode(cardDate.getDate() + " " + month[cardDate.getMonth()] + " " + cardDate.getFullYear());

                deadlineElement.appendChild(icon);
                deadlineElement.appendChild(dateText);

                if (cardDate > todayDate) {
                    var daysDifference = Math.round((todayDate - cardDate)/(1000*60*60*24));
                    if (daysDifference >= -7 && daysDifference <= 0) { // One week out
                        deadlineElement.style.color = "orange";
                    }
                } else { // Has expired
                    deadlineElement.style.color = "red";
                }

                return deadlineElement;
            }


            function clearBoard() {
                document.getElementById("board").innerHTML = "";
            }

            function clearMilestonesList() {
                var elem = document.getElementById("textMilestone");
                removeChildren(elem);
            }

            function clearAssigneesList() {
                assignees = new Map();
                var elem = document.getElementById("textAssignee");
                removeChildren(elem);
                elem.setAttribute("disabled", "");
            }

            function filterByAssignee(name) {
                var cards = document.querySelectorAll(".card");
                cards.forEach(function(card) {
                    var fullname = card.querySelector(".fullname").innerHTML;
                    if (name == fullname || name == "ALL") {
                        card.style.display = "block";
                    } else {
                        card.style.display = "none";
                    }
                });

                // force reload
                showColumnCounts();
            }

            function httpPut(url, dataObj, successCallback, errorCallback) {
                httpRequest("PUT", url, dataObj, successCallback, errorCallback);
            }

            function httpGet(url, successCallback, errorCallback) {
                httpRequest("GET", url, "", successCallback, errorCallback);
            }

            function httpRequest(method, url, dataObj, successCallback, errorCallback) {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        if (response == "") {
                            var msg = "No response from " + bzSiteUrl + " for request " + url;
                            console.warn(msg);
                            alert(msg);
                            return;
                        }

                        var obj = JSON.parse(response);
                        if (xhr.status == 200) {
                            return successCallback(obj);
                        }

                        if (obj.error != null) {
                            hideSpinner();
                            switch (obj.code) {
                                case 32000:
                                    // auth token has expired
                                    localStorage.removeItem(bzSiteUrl);
                                    showSignInButton();
                                    break;
                            }

                            console.error(obj.message);

                            if (errorCallback != undefined) {
                                errorCallback(obj);
                            } else {
                                alert(obj.message);
                            }
                        }
                    }
                }
                xhr.open(method, bzSiteUrl + url);
                xhr.setRequestHeader("Accept", "application/json");
                xhr.send(JSON.stringify(dataObj));
            }

            function getURLParameter(parameter) {
                return decodeURIComponent((new RegExp('[?|&]' + parameter + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
            }

            function getCardElement(bugId) {
                var bugAttr = '[data-bug-id="' + bugId + '"]';
                return document.querySelector(bugAttr);
            }

            function showSpinner() {
                var i = document.createElement('i');
                i.className = "fa fa-cog fa-spin fa-lg"
                document.getElementById("spinner").appendChild(i);
            }

            function hideSpinner() {
                var elem = document.getElementById("spinner");
                var icon = elem.firstChild;
                if (icon != undefined) {
                    elem.removeChild(icon);
                }
            }

            function doAuth(user, password) {
                showSpinner();
                httpGet("/rest/login?login=" + user + "&password=" + password, function(response) {
                    hideSpinner();
                    authObject = { 'userID': response.id, 'userToken': response.token };
                    localStorage.setItem(bzSiteUrl, JSON.stringify(authObject));
                    loadName();
                    // Rebuild the board so dnd events are registered.
                    if (bzProduct != null || bzAssignedTo != null) {
                        loadBoard();
                    }
                    hideLoginForm();
                });
            }

            function isLoggedIn() {
                return authObject != null;
            }

            function showLoginForm() {
                var elem = document.getElementById("loginForm");
                elem.style.display = "inline-block";
                hideSignInButton();
            }

            function hideLoginForm() {
                var elem = document.getElementById("loginForm");
                elem.style.display = "none";
            }

            function showSignInButton() {
                document.getElementById("btnSignIn").style.display = "inline-block";
            }

            function hideSignInButton() {
                document.getElementById("btnSignIn").style.display = "none";
            }

            function showColumnCounts() {
                var cols = document.querySelectorAll(".board-column");
                cols.forEach(function(col) {
                    var cardCount = col.querySelector(".board-column-card-count");
                    if (cardCount != undefined) {
                        cardCount.remove();
                    }
                    cardCount = document.createElement('span');
                    cardCount.className = "board-column-card-count";

                    var cards = col.querySelectorAll(".card");
                    var count = 0;
                    cards.forEach(function(card) {
                        // Account for filtered out cards
                        if (card.style.display != "none") {
                            count++;
                        }
                    });
                    cardCount.innerText += "(" + count + ")";
                    var title = col.firstChild;
                    title.appendChild(cardCount);
                });
            }

            function writeBug(bugID, fromStatus, targetStatus, bugResolution, bugPriority, bugSeverity, bugMilestone) {
                var dataObj = {
                    status: targetStatus,
                    resolution : "",
                    priority : "",
                    severity : "",
                    token : authObject.userToken,
                    comment : "",
                    target_milestone : ""
                }

                if (bugResolution != "") {
                    dataObj.resolution = bugResolution;
                } else {
                    delete dataObj.resolution;
                }

                if (bugPriority != "") {
                    dataObj.priority = bugPriority;
                } else {
                    delete dataObj.priority;
                }

                if (bugMilestone != "") {
                    dataObj.target_milestone = bugMilestone;
                } else {
                    delete dataObj.target_milestone;
                }

                if (bugSeverity != "") {
                    dataObj.severity = bugSeverity;
                } else {
                    delete dataObj.severity;
                }

                var bugComment = { body : "" };

                // TODO: Comment box popup
                if (shouldAutoComment) {
                    bugComment.body = "Auto-comment from bzKanban";
                }

                if (bugComment.body != "") {
                    dataObj.comment = bugComment;
                } else {
                    delete dataObj.comment;
                }

                // TODO: maybe check if bugID != number
                httpPut("/rest/bug/" + bugID, dataObj, function() {
                    loadBoard();
                });
            }

            function scheduleCheckForUpdates() {
                window.setTimeout(function() {
                    loadCheckForUpdates();
                }, 600000);
            }

            function dragCardOver(ev) {
                ev.preventDefault();
            }

            function dragCardEnter(ev) {
                ev.preventDefault();

                var getCardEvData = ev.dataTransfer.getData("text");
                if (getCardEvData) {
                    var bugData = JSON.parse(getCardEvData);
                    if (bugData.status != ev.currentTarget.id) {
                        ev.currentTarget.classList.add("drag-card");
                    }
                }

                if (ev.target.classList.contains("drop-target")) {
                    ev.target.classList.add("drop-target-hover");
                }
            }

            function dragCardLeave(ev) {
                ev.currentTarget.classList.remove("drag-card");

                if (ev.target.classList.contains("drop-target")) {
                    ev.target.classList.remove("drop-target-hover");
                }
            }

            function dragCard(ev) {
                var fromStatus = ev.target.parentElement.id;

                // Disable pointer-events for all other cards so that we
                // can reliably detect when a card enters and leaves a column.
                var cards = document.getElementsByClassName("card");
                for (var i = 0; i < cards.length; i++) {
                    if (cards[i].id != ev.currentTarget.id) {
                        cards[i].style.pointerEvents = "none";
                    }
                }

                var bugID = ev.currentTarget.dataset.bugId;
                var bugData = {"id": bugID, "status": fromStatus};
                ev.dataTransfer.setData("text", JSON.stringify(bugData));
            }

            function dragCardStart(ev) {
                columnTitle = ev.currentTarget.childNodes[0].childNodes[0].data;
                if (!(columnTitle == "UNCONFIRMED" || columnTitle == "VERIFIED")) {
                    showResolutions(document.getElementById("RESOLVED"));
                    showPriorities(document.getElementById(columnTitle));
                    showSeverities(document.getElementById(columnTitle));
                }
                showBacklog(true);
            }

            function dragCardEnd(ev) {
                columnTitle = ev.currentTarget.childNodes[0].childNodes[0].data;
                if (!(columnTitle == "UNCONFIRMED" || columnTitle == "VERIFIED")) {
                    hideResolutions(document.getElementById("RESOLVED"));
                    hidePriorities(document.getElementById(columnTitle));
                    hideSeverities(document.getElementById(columnTitle));
                }
                showBacklog(false);
            }

            function dropCard(ev) {
                // Re-enable pointer events for all cards.
                var cards = document.getElementsByClassName("card");
                for (var i = 0; i < cards.length; i++) {
                    cards[i].style.pointerEvents = "auto";
                }

                ev.currentTarget.classList.remove("drag-card");

                ev.preventDefault();

                var bugData = JSON.parse(ev.dataTransfer.getData("text"));

                var targetStatus = ev.currentTarget.id;
                var targetResolution = "";
                var targetPriority = "";
                var targetSeverity = "";
                if (ev.target.classList.contains("resolution")) {
                    targetResolution = ev.target.id;
                } else if (ev.target.classList.contains("priority")) {
                    targetPriority = ev.target.id;
                } else if (ev.target.classList.contains("severity")) {
                    targetSeverity = ev.target.id;
                }

                writeBug(bugData.id, bugData.status, targetStatus, targetResolution, targetPriority, targetSeverity, "");
            }

            function dropBacklog(ev) {
                if (ev.target.classList.contains("drop-target")) {
                    ev.target.classList.remove("drop-target-hover");
                }
                ev.preventDefault();

                var bugData = JSON.parse(ev.dataTransfer.getData("text"));

                var targetStatus = "CONFIRMED";
                var targetResolution = "";
                var targetPriority = defaultPriority;
                var targetSeverity = defaultSeverity;

                writeBug(bugData.id, bugData.status, targetStatus, targetResolution, targetPriority, targetSeverity, defaultMilestone);

            }

            function showResolutions(elem) {
                var resolutions = elem.getElementsByClassName("resolutions");
                for (var i = 0; i < resolutions.length; i++) {
                    resolutions[i].hidden = false;
                }
                toggleCards(elem, true);
            }

            function hideResolutions(elem) {
                var resolutions = elem.getElementsByClassName("resolutions");
                for (var i = 0; i < resolutions.length; i++) {
                    resolutions[i].hidden = true;
                }
                toggleCards(elem, false);
            }

            function showPriorities(elem) {
                var priorities = elem.getElementsByClassName("priorities");
                for (var i = 0; i < priorities.length; i++) {
                    priorities[i].hidden = false;
                }
                toggleCards(elem, true);
            }

            function hidePriorities(elem) {
                var priorities = elem.getElementsByClassName("priorities");
                for (var i = 0; i < priorities.length; i++) {
                    priorities[i].hidden = true;
                }
                toggleCards(elem, false);
            }

            function showSeverities(elem) {
                var severities = elem.getElementsByClassName("severities");
                for (var i = 0; i < severities.length; i++) {
                    severities[i].hidden = false;
                }
                toggleCards(elem, true);
            }

            function hideSeverities(elem) {
                var severities = elem.getElementsByClassName("severities");
                for (var i = 0; i < severities.length; i++) {
                    severities[i].hidden = true;
                }
                toggleCards(elem, false);
            }

            function toggleCards(elem, state) {
                var cards = elem.getElementsByClassName("card");
                for (var i = 0; i < cards.length; i++) {
                    cards[i].hidden = state;
                }
            }

            function isTrue(string) {
                return (string === 'true');
            }

            function removeChildren(elem) {
                while (elem.firstChild) {
                    elem.removeChild(elem.firstChild);
                }
            }

            function getPictureSrc(email) {
                var hash = CryptoJS.MD5(email);
                var hashString = hash.toString(CryptoJS.enc.Base64);

                if (!(hashString == "")) {
                    return ('http://www.gravatar.com/avatar/' + hashString + '?s=20&d=blank');
                }
            }

            function hidePicture(pictureobject) {
                pictureobject.style.display = "none";
            }

            // Register event handlers
            document.getElementById("textProduct").addEventListener("input", function() {
                // Disable Milestones until it's refreshed
                document.getElementById("textMilestone").disabled = true;
                // Clear any previous selections.
                bzProductMilestone = "";
                loadMilestonesList();
                clearAssigneesList();
                });

            document.getElementById("textMilestone").addEventListener("input", function() {
                clearAssigneesList();
                });

            document.getElementById("textAssignee").addEventListener("input", function() {
                var email = document.getElementById("textAssignee").value;
                var name = assignees.get(email).real_name;
                filterByAssignee(name);
                });

            document.getElementById("btnCreate").addEventListener("click", function() {
                var product = document.getElementById("textProduct").value;
                window.open(bzSiteUrl + "/enter_bug.cgi?product=" + product);
                });

            document.getElementById("btnSignIn").addEventListener("click", function() {
                showLoginForm();
                });

            document.getElementById("btnAuthSubmit").addEventListener("click", function() {
                var user = document.getElementById("textUsername").value;
                var password = document.getElementById("textPassword").value;
                doAuth(user, password);
                });

            document.addEventListener("visibilitychange", function() {
                if (document.hidden) {
                    shouldCheckForUpdates = false;
                } else {
                    shouldCheckForUpdates = true;
                    loadCheckForUpdates();
                }
                });

            document.getElementById("textPassword").addEventListener("keyup", function(event) {
                event.preventDefault();
                if (event.keyCode == 13) {
                    document.getElementById("btnAuthSubmit").click();
                }
                });

        </script>
    </body>
</html>
