<html>
    <head>
        <title>Bz Kanban Board</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

        <style>
            body {
                background-color: lightsteelblue;
                background: linear-gradient(to bottom, rgba(207,231,250,1) 0%,rgba(99,147,193,1) 100%);
                font-family: sans-serif;
                margin: 0;
                display: flex;
                height: 100%;
                flex-direction: column;
            }
            #board {
                display: flex;
                padding-top: 20px;
            }
            .board-column-title {
                text-align: center;
                font-weight: bold;
                margin-bottom: 5px;
            }
            .cards {
                overflow-x: hidden;
                align-self: stretch;
            }
            .board-column-card-count {
                font-size: small;
                color: grey;
                margin-left: 10px;
            }
            .board-column {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .board-column.drag-card {
                outline-width: 2px;
                outline-style: dashed;
                outline-color: grey;
            }
            .card {
                background-color: white;
                border-width: 1px;
                border-color: grey;
                border-style: solid;
                border-radius: 5px;
                padding: 10px;
                margin: 3px;
                font-size: small;
            }
            .card:hover {
                background-color: ghostwhite;
                border-color: black;
            }
            .card-ref {
                font-size: smaller;
            }
            .card-summary {
                padding-top: 5px;
            }
            .card-meta {
                font-size: smaller;
                color: grey;
                padding: 1px;
                margin-top: 15px;
                display: flex;
                flex-direction: row;
                align-items: center;
                flex-wrap: wrap;
                justify-content: flex-start;
            }
            .card-meta .assignee {
                display: flex;
                flex: 1 1 auto;
                align-items: center;
                flex-wrap: wrap;
                justify-content: flex-end;
            }
            .card-meta .assignee img#picture {
                margin-left: 5px;
            }
            .card-meta #icons {
            }
            .card-meta #deadline {
                margin-right: 5px;
            }
            .card-meta #comment {
                margin-right: 5px;
            }
            .card-meta #severity,
            .card-meta #priority {
                border-radius: 3px;
                border-width: 1px;
                border-style: solid;
                margin-right: 5px;
                padding: 1px;
            }
            .card-meta #severity[data-severity='blocker'],
            .card-meta #severity[data-severity='critical'],
            .card-meta #severity[data-severity='major'] {
                color: red;
            }
            .card-meta #severity[data-severity='normal'],
            .card-meta #severity[data-severity='minor'],
            .card-meta #severity[data-severity='trivial'] {
                color: gray;
            }
            .card-meta #severity[data-severity='enhancement'] {
                color: green;
            }
            .card-meta #priority[data-priority='P1'],
            .card-meta #priority[data-priority='Highest'] {
                color: red;
            }
            .card-meta #priority[data-priority='P2'],
            .card-meta #priority[data-priority='High'] {
                color: orange;
            }
            .card-meta #priority[data-priority='P3'],
            .card-meta #priority[data-priority='Normal'],
            .card-meta #priority[data-priority='normal'],
            .card-meta #priority[data-priority='---'] {
                color: green;
            }
            fieldset {
                border-width: 0;
            }
            #textBacklog {
                width: 100px;
                border-style: solid;
                border-color: white;
                border-width: thin;
                text-align: center;
                align-self: center;
                display: none;
                font-size: small;
                margin-left: 15px;
            }
            #query .fa {
                vertical-align: middle;
            }
            #query select {
                width: 150px;
            }
            #query span {
                margin-right: 15px;
            }
            #loginForm {
                display: none;
                font-size: small;
                margin-bottom: 0;
                padding-left: 15px;
            }
            #whoami {
                font-size: small;
            }
            .priorities,
            .severities,
            .resolutions {
                align-self: stretch;
            }
            .priority,
            .severity,
            .resolution {
                background: darkgray;
                color: black;
                text-align: -webkit-center;
                border: thin solid black;
                margin-top: 10px;
                padding: 10px;
                margin: 5px;
                font-size: small;
            }
            #title {
                background: none;
                font-weight: bold;
                border: none;
                display: inline;
            }
            .drop-target-hover {
                background: gold;
            }
            #notification {
                display: none;
            }
            #nav {
                flex: none;
                display: flex;
                flex-wrap: wrap;
                padding: 20px;
                border-bottom-width: 1px;
                border-bottom-style: solid;
                border-bottom-color: ghostwhite;
            }
            #nav span {
                align-self: center;
            }
            #nav .spring {
                flex: 1;
            }
            #spinner {
                padding-right: 5px;
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 1;
                padding-top: 100px;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgb(0,0,0);
                background-color: rgba(0,0,0,0.4);
            }
            .modal-content {
                display: flex;
                background-color: #fefefe;
                margin: auto;
                flex-direction: column;
                align-items: flex-start;
                width: 30%;
                box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
                animation-name: animatetop;
                animation-duration: 0.4s
            }
            @keyframes animatetop {
                from {top:-300px; opacity:0}
                to {top:0; opacity:1}
            }
            .modalClose {
                color: white;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }
            .modalClose:hover,
            .modalClose:focus {
                color: #000;
                text-decoration: none;
                cursor: pointer;
            }
            .modal-header {
                padding: 2px 16px;
                background-color: rgb(99,147,193);
                color: white;
                align-self: stretch;
            }
            .modal-body {
                display: flex;
                padding: 2px 16px;
                flex-direction: column;
                align-self: stretch;
            }
            .modal-body input {
                width: 100%;
            }
            .modal-body button#btnModalSubmit {
                width: 80px;
                text-align: center;
                align-self: flex-end;
                margin-bottom: 10px;
            }
            .modal-body textarea {
                width: 100%;
                height: 100px;
            }
            .modal-body select {
                width: 40%;
            }
            .modal-body label {
                margin: 10px 0px 0px 5px;
            }
            .modal-body ul {
                margin: 0px;
            }
            #newbugDefaults {
                display: none;
            }
        </style>
    </head>
    <body>
        <div id="nav">
            <span id="query">
                <span>
                    <i class="fa fa-archive"></i>
                    <select id="textProduct" name="product" placeholder="Product"></select>
                </span>
                <span>
                    <i class="fa fa-flag"></i>
                    <select id="textMilestone" name="milestone" placeholder="Milestone"></select>
                </span>
                <span>
                    <i class="fa fa-user"></i>
                    <select id="textAssignee" name="assignee" placeholder="Assignee Email" disabled></select>
                </span>
            </span>
            <div id="textBacklog" class="drop-target" ondragenter="return dragCardEnter(event)" ondrop="return dropBacklog(event)" ondragover="return dragCardOver(event)" ondragleave="return dragCardLeave(event)">Backlog</div>
            <span class="spring"></span>
            <span id="spinner"></span>
            <span id="actions">
                <button id="btnCreate">New Bug</button>
                <span id="whoami"></span>
                <button id="btnSignIn">Login</button>
                <i id="notification" class="fa fa-bell"></i>
            </span>
            <form id="loginForm">
                <span>
                    <label for="textUserName">Username</label>
                    <input type="text" required id="textUsername" name="username" value="">
                </span>
                <span>
                    <label for="textPassword" >Password</label>
                    <input type="password" required id="textPassword" name="password" value="">
                </span>
                <input type="button" id="btnAuthSubmit" value="Submit">
            </form>
        </div>
        <div id="modalAddBug" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modalClose">x</span>
                    <h2 id="textModalHeader">Add New Bug</h2>
                </div>
                <div class="modal-body">
                    <label>Summary of the issue
                        <input type="text" required id="textAddBugSummary" name="summary" value="">
                    </label>
                    <label>Detailed description
                        <textarea id="textAddBugDescription" name="description" value=""></textarea>
                    </label>
                    <label>Component
                        <select id="textComponent" name="component" placeholder="Component" value=""></select>
                    </label>
                    <label>Version
                        <select id="textVersion" name="version" placeholder="Version"></select>
                    </label>
                    <div id="newbugDefaults">
                        <label>Using Bugzilla defaults</label>
                        <ul style="list-style-type:circle">
                            <li>op_sys = <label id="labelOpSys"></label></li>
                            <li>platform = <label id="labelPlatform"></label></li>
                            <li>priority = <label id="labelPriority"></label></li>
                            <li>severity = <label id="labelSeverity"></label></li>
                        </ul>
                    </div>
                    <button id="btnModalSubmit">Submit</button>
                </div>
            </div>
        </div>
        <div id="board">
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/md5.js"></script>
        <script type="text/javascript">
            var bzComponent = "";
            var bzPriority = "";
            var bzAssignedTo = "";
            var bzOrder = "priority,bug_severity,assigned_to";
            var bzSiteUrl = "http://bugzilla.msec.local";
            var userFullName = "";
            var userGravatar = true;
            var bzProduct = "";
            var bzProductMilestone = "";
            var bzBoardLoadTime = "";
            var bzRestGetBugsUrl = "";
            var shouldCheckForUpdates = true;
            var shouldLoadComments = false;
            var shouldAutoComment = false;
            var shouldAutoRefresh = false;
            var assignees = new Map();
            var defaultPriority;
            var defaultSeverity;
            var defaultMilestone;
            var authObject;

            window.onload = loadParams;

            function loadParams() {
                bzProduct = getURLParameter('product');
                bzProductMilestone = getURLParameter('milestone');

                var assignee = getURLParameter('assignee');
                if (assignee !== null) {
                    bzAssignedTo = assignee;
                }

                // Allow the Bugzilla site URL to be overriden. Useful for testing.
                // For most permanent deployments just change the hardcodecoded bzSiteUrl.
                var site = getURLParameter('site');
                if (site !== null) {
                    bzSiteUrl = site;
                }

                // Loading comments is expensive becase it's one extra request per bug.
                // Causing some Bugzilla servers to respond with "too many requests" errors.
                var comments = getURLParameter('comments');
                if (comments !== null) {
                    shouldLoadComments = isTrue(comments);
                }

                var autocomment = getURLParameter('autocomment');
                if (autocomment !== null) {
                    shouldAutoComment = isTrue(autocomment);
                }

                var pictures = getURLParameter('gravatar');
                if (pictures !== null) {
                    userGravatar = isTrue(pictures);
                }

                var autorefresh = getURLParameter('autorefresh');
                if (autorefresh !== null) {
                    shouldAutoRefresh = isTrue(autorefresh);
                }

                authObject = JSON.parse(localStorage.getItem(bzSiteUrl));

                if (isLoggedIn()) {
                    loadName();
                    hideSignInButton();
                }

                // Disable input fields until response is complete.
                // Having the user keep clicking the drop down isn't nice.
                document.getElementById("textProduct").disabled = true;
                document.getElementById("textMilestone").disabled = true;

                loadProductsList();
            }

            function loadBoard() {
                showSpinner();
                httpGet("/rest/field/bug/status/values", function(response) {
                    clearBoard();
                    var statuses = response.values;
                    statuses.forEach(function(status) {
                        addBoardColumn(status);
                        document.getElementsByClassName("board-column").UNCONFIRMED.style.display = "none";
                    });
                    if (bzProduct !== null) {
                        httpGet("/rest/product/" + bzProduct + "?include_fields=has_unconfirmed", function(response) {
                            // Unhide UNCONFIRMED column if product has enabled it.
                            // But, product name may not have been provided if querying only on email.
                            if (response.products[0].has_unconfirmed) {
                                // Reset style to default CSS
                                document.getElementsByClassName("board-column").UNCONFIRMED.style.display = "";
                            }
                        });
                    }
                    loadBugs();
                    if (isLoggedIn()) {
                        loadResolutions();
                        loadPriorities();
                        loadSeverities();
                        loadDefaultPrioritySeverityFields();
                        loadDefaultMilestone();
                        loadComponentsList();
                        loadVersionsList();
                    }
                });
            }

            function loadBugs() {
                bzBoardLoadTime = new Date().toISOString();

                bzRestGetBugsUrl = "/rest/bug?product=" + bzProduct;
                bzRestGetBugsUrl += "&include_fields=summary,status,id,severity,priority,assigned_to,last_updated,deadline";
                bzRestGetBugsUrl += "&order=" + bzOrder;
                bzRestGetBugsUrl += "&target_milestone=" + bzProductMilestone;
                bzRestGetBugsUrl += "&component=" + bzComponent;
                bzRestGetBugsUrl += "&priority=" + bzPriority;

                httpGet(bzRestGetBugsUrl, function(response) {
                    var bugs = response.bugs;

                    bugs.forEach(function(bug) {
                        addCard(bug);
                    });

                    showColumnCounts();
                    loadAssigneesList();
                    if (bzAssignedTo != "") {
                        var name = assignees.get(bzAssignedTo).real_name;
                        filterByAssignee(name);
                    }
                    hideSpinner();
                    scheduleCheckForUpdates();
                });

            }

            function loadProductsList() {
                httpGet("/rest/product?type=enterable&include_fields=name", function(response) {
                    document.getElementById("textProduct").disabled = false;
                    var products = response.products;
                    products.sort(function(a, b) {
                        return a.name.localeCompare(b.name);
                    });
                    products.forEach(function(product) {
                        var option = document.createElement('option');
                        option.value = product.name;
                        option.text = product.name;
                        document.getElementById("textProduct").appendChild(option);
                    });
                    // select it in list.
                    document.getElementById("textProduct").value = bzProduct;
                    if (bzProduct !== null) {
                        loadMilestonesList();
                    }
                });
            }

            function loadMilestonesList() {
                bzProduct = document.getElementById("textProduct").value;
                clearMilestonesList();
                httpGet("/rest/product?names=" + bzProduct + "&include_fields=milestones", function(response) {
                    document.getElementById("textMilestone").disabled = false;
                    var milestones = response.products[0].milestones;
                    milestones.forEach(function(milestone) {
                        var option = document.createElement('option');
                        option.value = milestone.name;
                        option.text = milestone.name;
                        document.getElementById("textMilestone").appendChild(option);
                    });
                    // select it in list.
                    document.getElementById("textMilestone").value = bzProductMilestone;
                    if (bzProduct !== "" && bzProductMilestone !== "") {
                        loadBoard();
                    }
                });
            }

            function loadAssigneesList() {
                // HACK add phony user so that we can show all users
                assignees.set( "", { real_name: "ALL", email: "" });

                var sorted = Array.from(assignees.values()).sort(function(a, b) {
                    return a.real_name.localeCompare(b.real_name);
                });

                var elem = document.getElementById("textAssignee");

                sorted.forEach(function(assignee) {
                    var option = document.createElement('option');
                    option.value = assignee.email;
                    option.text = assignee.real_name;
                    elem.appendChild(option);
                });
                // select it in list.
                document.getElementById("textAssignee").value = bzAssignedTo;

                elem.removeAttribute("disabled");
            }

            function loadComments(bug) {
                httpGet("/rest/bug/" + bug.id + "/comment?include_fields=id", function(response) {
                    var card = getCardElement(bug.id);
                    var commentCount = response.bugs[bug.id].comments.length - 1;
                    if (commentCount > 1) {
                        var commentElement = card.children.cardmeta.children.icons.children.comment;
                        commentElement.style.display = null; // unhide it

                        var icon = document.createElement('i');
                        icon.setAttribute("class", "fa fa-comment-o fa-sm");
                        icon.style.marginRight = "4px";

                        commentElement.appendChild(icon);
                        commentElement.appendChild(document.createTextNode(commentCount));
                    }
                });
            }

            function loadName() {
                httpGet("/rest/user/" + authObject.userID + "?token=" + authObject.userToken, function(response) {
                    userFullName = response.users[0].real_name;
                    if (userFullName !== null) {
                        document.getElementById("whoami").textContent = userFullName;
                    }
                });
            }

            function loadResolutions() {
                httpGet("/rest/field/bug/resolution", function(response) {
                    var arrayResolutions = response.fields;

                    var resolutions = document.createElement("div");
                    resolutions.className = "resolutions";
                    resolutions.hidden = true;

                    var labelbox = document.createElement("div");
                    labelbox.className = "resolution";
                    labelbox.innerText += arrayResolutions[0].display_name;
                    labelbox.id = "title";
                    resolutions.appendChild(labelbox);

                    arrayResolutions[0].values.forEach(function(resolution) {
                        var resolutionName = resolution.name;
                        if (resolutionName !== "") {
                            var box = document.createElement("div");
                            box.className = "resolution drop-target";
                            box.innerText += resolutionName;
                            box.id = resolutionName;
                            resolutions.appendChild(box);
                        }
                    });

                    // FIXME: this assumes the column name, but it may have been renamed by the bz instance.
                    document.getElementById("RESOLVED").appendChild(resolutions);
                });
            }

            function loadPriorities() {
                httpGet("/rest/field/bug/priority", function(response) {
                    // FIXME: this assumes the column name, but it may have been renamed by the bz instance.
                    var columns = ["CONFIRMED", "IN_PROGRESS"];

                    columns.forEach(function(column) {
                        var arrayPriorities = response.fields;

                        priorities = document.getElementById(column).getElementsByClassName("priorities")[0];

                        var labelbox = document.createElement("div");
                        labelbox.className = "priority";
                        labelbox.innerText += arrayPriorities[0].display_name;
                        labelbox.id = "title";
                        priorities.appendChild(labelbox);

                        arrayPriorities[0].values.forEach(function(priority) {
                            var priorityName = priority.name;
                            if (priorityName !== "") {
                                var box = document.createElement("div");
                                box.className = "priority drop-target";
                                box.innerText += priorityName;
                                box.id = priorityName;
                                priorities.appendChild(box);
                            }
                        });
                    });
                });
            }

            function loadSeverities() {
                httpGet("/rest/field/bug/bug_severity", function(response) {
                    // FIXME: this assumes the column name, but it may have been renamed by the bz instance.
                    var columns = ["CONFIRMED", "IN_PROGRESS"];

                    columns.forEach(function(column) {
                        var arraySeverities = response.fields;

                        severities = document.getElementById(column).getElementsByClassName("severities")[0];

                        var labelbox = document.createElement("div");
                        labelbox.className = "severity";
                        labelbox.innerText += arraySeverities[0].display_name;
                        labelbox.id = "title";
                        severities.appendChild(labelbox);

                        arraySeverities[0].values.forEach(function(severity) {
                            var severityName = severity.name;
                            if (severityName !== "") {
                                var box = document.createElement("div");
                                box.className = "severity drop-target";
                                box.innerText += severityName;
                                box.id = severityName;
                                severities.appendChild(box);
                            }
                        });
                    });
                });
            }

            function loadComponentsList() {
                httpGet("/rest/product/" + bzProduct + "?type=enterable&include_fields=components", function(response) {
                    var components = response.products[0].components;
                    components.sort(function(a, b) {
                        return a.name.localeCompare(b.name);
                    });
                    components.forEach(function(component) {
                        if (!(component.is_active)) { return }
                        var opt = document.createElement('option');
                        opt.innerText = component.name;
                        opt.value = component.name;
                        document.getElementById("textComponent").appendChild(opt);
                    });
                });
            }

            function loadVersionsList() {
                httpGet("/rest/product/" + bzProduct + "?type=enterable&include_fields=versions", function(response) {
                    var versions = response.products[0].versions;
                    versions.sort(function(a, b) {
                        return a.name.localeCompare(b.name);
                    });
                    versions.forEach(function(version) {
                        if (!(version.is_active)) { return }
                        var opt = document.createElement('option');
                        opt.innerText = version.name;
                        opt.value = version.name;
                        document.getElementById("textVersion").appendChild(opt);
                    });
                });
            }

            function loadCheckForUpdates() {
                if (bzBoardLoadTime === "") {
                    shouldCheckForUpdates = false;
                    return;
                }
                httpGet(bzRestGetBugsUrl + "&last_change_time=" + bzBoardLoadTime, function(response) {
                    if (response.bugs.length > 0) {
                        if (shouldAutoRefresh) {
                            loadBoard();
                        } else {
                            var bell = document.getElementById("notification");
                            bell.style.display = "inline";
                            bell.title = response.bugs.length + " bug(s) have been updated externally. Hit refresh!";
                        }
                    }

                    if (shouldCheckForUpdates) {
                        // Repeat.
                        scheduleCheckForUpdates();
                    }
                });
            }

            function loadDefaultPrioritySeverityFields() {
                httpGet("/rest/parameters?token=" + authObject.userToken, function(response) {
                    defaultOpSys = response.parameters.defaultopsys;
                    defaultPlatform = response.parameters.defaultplatform;
                    defaultPriority = response.parameters.defaultpriority;
                    defaultSeverity = response.parameters.defaultseverity;

                    textOpSys = document.getElementById("labelOpSys");
                    textPlatform = document.getElementById("labelPlatform");
                    textPriority = document.getElementById("labelPriority");
                    textSeverity = document.getElementById("labelSeverity");

                    document.getElementById("textModalHeader").innerText = "Add new bug to milestone " + bzProductMilestone;

                    if (defaultOpSys !== null && defaultOpSys.length !== 0) {
                        textOpSys.innerHTML = defaultOpSys;
                        textOpSys.value = defaultOpSys;
                    } else {
                        textOpSys.innerHTML = "blank (but setting to ALL)";
                        textOpSys.value = defaultOpSys;
                        textOpSys.style.fontStyle = "italic";
                    }
                    if (defaultPlatform !== null && defaultPlatform.length !== 0) {
                        textPlatform.innerHTML = defaultPlatform;
                        textPlatform.value = defaultPlatform;
                    } else {
                        textPlatform.innerHTML = "blank (but setting to ALL)";
                        textPlatform.value = defaultPlatform;
                        textPlatform.style.fontStyle = "italic";
                    }
                    if (defaultPriority !== null && defaultPriority.length !== 0) {
                        textPriority.innerHTML = defaultPriority;
                        textPriority.value = defaultPriority;
                    } else {
                        textPriority.innerHTML = "blank";
                        textPriority.value = defaultPriority;
                        textPriority.style.fontStyle = "italic";
                    }
                    if (defaultSeverity !== null && defaultSeverity.length !== 0) {
                        textSeverity.innerHTML = defaultSeverity;
                        textSeverity.value = defaultSeverity;
                    } else {
                        textSeverity.innerHTML = "blank";
                        textSeverity.value = defaultSeverity;
                        textSeverity.style.fontStyle = "italic";
                    }
                });
            }

            function loadDefaultMilestone() {
                httpGet("/rest/product/" + bzProduct + "?type=enterable&include_fields=default_milestone", function(response) {
                    defaultMilestone = response.products[0].default_milestone;
                });
            }

            function addBoardColumn(status) {
                var div = document.createElement('div');
                div.className = "board-column";
                div.id = status;
                if (isLoggedIn()) {
                    div.addEventListener('drag', dragCardStart);
                    div.addEventListener('dragend', dragCardEnd);
                    div.addEventListener('dragover', dragCardOver);
                    div.addEventListener('drop', dropCard);
                    div.addEventListener('dragenter', dragCardEnter);
                    div.addEventListener('dragleave', dragCardLeave);
                }
                document.getElementById("board").appendChild(div);

                var title = document.createElement('div');
                title.className = "board-column-title";
                title.innerHTML = status;
                document.getElementById(status).appendChild(title);

                var cards = document.createElement('div');
                cards.className = "cards";
                document.getElementById(status).appendChild(cards);

                var prioritycontainer = document.createElement('div');
                prioritycontainer.className = "priorities";
                prioritycontainer.hidden = true;
                document.getElementById(status).appendChild(prioritycontainer);

                var severitycontainer = document.createElement('div');
                severitycontainer.className = "severities";
                severitycontainer.hidden = true;
                document.getElementById(status).appendChild(severitycontainer);

            }

            function addCard(bug) {
                var card = document.createElement('div');
                card.className = "card";
                card.dataset.bugId = bug.id;

                var buglink = document.createElement('a');
                buglink.href= bzSiteUrl + "/show_bug.cgi?id=" + bug.id;
                buglink.innerHTML = "#" + bug.id;
                buglink.className = "card-ref";

                var summary = document.createElement('div');
                summary.appendChild(document.createTextNode(bug.summary)); // so that we get HTML string escaping for free
                summary.className = "card-summary";

                var meta = document.createElement('div');
                meta.className = "card-meta";
                meta.setAttribute("id", "cardmeta");

                var assignee = document.createElement('span');
                assignee.className = "assignee";

                var fullname = document.createElement('span');
                fullname.className = "fullname";
                fullname.innerHTML = bug.assigned_to_detail.real_name;

                var picture = document.createElement('img');
                picture.setAttribute("id", "picture");
                if (userGravatar) {
                    picture.src = getPictureSrc(bug.assigned_to_detail.email);
                } else {
                    hidePicture(picture);
                }

                var icons = document.createElement('span');
                icons.setAttribute("id", "icons");

                var comment = document.createElement('span');
                comment.setAttribute("id", "comment");
                comment.style.display = "none";

                var deadline = createDeadlineElement(bug.deadline);

                var priority = document.createElement('span');
                priority.setAttribute("id", "priority");
                priority.innerHTML = bug.priority;
                priority.dataset.priority = bug.priority;

                var severity = document.createElement('span');
                severity.setAttribute("id", "severity");
                severity.innerHTML = bug.severity;
                severity.dataset.severity = bug.severity;

                card.appendChild(buglink);
                card.appendChild(summary);
                card.appendChild(meta);
                meta.appendChild(icons);
                icons.appendChild(priority);
                icons.appendChild(severity);
                icons.appendChild(comment);
                icons.appendChild(deadline);
                assignee.appendChild(fullname);
                assignee.appendChild(picture);
                meta.appendChild(assignee);

                if (isLoggedIn()) {
                    card.draggable = "true";
                    card.addEventListener('dragstart', dragCard);
                }

                if (shouldLoadComments) {
                    loadComments(bug);
                }

                document.querySelector("#" + bug.status + " .cards").appendChild(card);

                assignees.set(bug.assigned_to_detail.email, bug.assigned_to_detail); // save for later
            }

            function createDeadlineElement(deadline) {
                var deadlineElement = document.createElement('span');
                deadlineElement.setAttribute("id", "deadline");

                if (deadline === undefined || deadline === null) {
                    deadlineElement.style.display = "none";
                    return deadlineElement;
                }

                var month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"];
                var todayDate = Date.now();
                var cardDate = new Date();
                var dateArray = deadline.split('-');
                cardDate.setFullYear(dateArray[0], dateArray[1] - 1, dateArray[2]);

                var icon = document.createElement('i');
                icon.setAttribute("class", "fa fa-calendar-o fa-sm");
                icon.style.marginRight = "4px";

                var dateText = document.createTextNode(cardDate.getDate() + " " + month[cardDate.getMonth()] + " " + cardDate.getFullYear());

                deadlineElement.appendChild(icon);
                deadlineElement.appendChild(dateText);

                if (cardDate > todayDate) {
                    var daysDifference = Math.round((todayDate - cardDate)/(1000*60*60*24));
                    if (daysDifference >= -7 && daysDifference <= 0) { // One week out
                        deadlineElement.style.color = "orange";
                    }
                } else { // Has expired
                    deadlineElement.style.color = "red";
                }

                return deadlineElement;
            }


            function clearBoard() {
                clearAssigneesList();
                document.getElementById("board").innerHTML = "";
            }

            function clearMilestonesList() {
                var elem = document.getElementById("textMilestone");
                removeChildren(elem);
            }

            function clearAssigneesList() {
                assignees = new Map();
                var elem = document.getElementById("textAssignee");
                removeChildren(elem);
                elem.setAttribute("disabled", "");
            }

            function filterByAssignee(name) {
                var cards = document.querySelectorAll(".card");
                cards.forEach(function(card) {
                    var fullname = card.querySelector(".fullname").innerHTML;
                    if (name == fullname || name == "ALL") {
                        card.style.display = "block";
                    } else {
                        card.style.display = "none";
                    }
                });

                // force reload
                showColumnCounts();
            }

            function httpPut(url, dataObj, successCallback, errorCallback) {
                httpRequest("PUT", url, dataObj, successCallback, errorCallback);
            }

            function httpGet(url, successCallback, errorCallback) {
                httpRequest("GET", url, "", successCallback, errorCallback);
            }

            function httpRequest(method, url, dataObj, successCallback, errorCallback) {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        if (response === "") {
                            var msg = "No response from " + bzSiteUrl + " for request " + url;
                            console.warn(msg);
                            alert(msg);
                            return;
                        }

                        var obj = JSON.parse(response);
                        if (xhr.status == 200) {
                            return successCallback(obj);
                        }

                        if (obj.error !== null) {
                            hideSpinner();
                            switch (obj.code) {
                                case 32000:
                                    // auth token has expired
                                    localStorage.removeItem(bzSiteUrl);
                                    showSignInButton();
                                    break;
                            }

                            console.error(obj.message);

                            if (errorCallback !== undefined) {
                                errorCallback(obj);
                            } else {
                                alert(obj.message);
                            }
                        }
                    }
                };
                xhr.open(method, bzSiteUrl + url);
                xhr.setRequestHeader("Accept", "application/json");
                xhr.send(JSON.stringify(dataObj));
            }

            function getURLParameter(parameter) {
                return decodeURIComponent((new RegExp('[?|&]' + parameter + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
            }

            function getCardElement(bugId) {
                var bugAttr = '[data-bug-id="' + bugId + '"]';
                return document.querySelector(bugAttr);
            }

            function showSpinner() {
                var i = document.createElement('i');
                i.className = "fa fa-cog fa-spin fa-lg";
                document.getElementById("spinner").appendChild(i);
            }

            function hideSpinner() {
                var elem = document.getElementById("spinner");
                var icon = elem.firstChild;
                if (icon !== null) {
                    elem.removeChild(icon);
                }
            }

            function doAuth(user, password) {
                showSpinner();
                httpGet("/rest/login?login=" + user + "&password=" + password, function(response) {
                    hideSpinner();
                    authObject = { 'userID': response.id, 'userToken': response.token };
                    localStorage.setItem(bzSiteUrl, JSON.stringify(authObject));
                    loadName();
                    // Rebuild the board so dnd events are registered.
                    if (bzProduct !== null || bzAssignedTo !== "") {
                        loadBoard();
                    }
                    hideLoginForm();
                });
            }

            function isLoggedIn() {
                return authObject !== null;
            }

            function showLoginForm() {
                var elem = document.getElementById("loginForm");
                elem.style.display = "inline-block";
                hideSignInButton();
            }

            function hideLoginForm() {
                var elem = document.getElementById("loginForm");
                elem.style.display = "none";
            }

            function showSignInButton() {
                document.getElementById("btnSignIn").style.display = "inline-block";
            }

            function hideSignInButton() {
                document.getElementById("btnSignIn").style.display = "none";
            }

            function showColumnCounts() {
                var cols = document.querySelectorAll(".board-column");
                cols.forEach(function(col) {
                    var cardCount = col.querySelector(".board-column-card-count");
                    if (cardCount !== null) {
                        cardCount.remove();
                    }
                    cardCount = document.createElement('span');
                    cardCount.className = "board-column-card-count";

                    var cards = col.querySelectorAll(".card");
                    var count = 0;
                    cards.forEach(function(card) {
                        // Account for filtered out cards
                        if (card.style.display != "none") {
                            count++;
                        }
                    });
                    cardCount.innerText += "(" + count + ")";
                    var title = col.firstChild;
                    title.appendChild(cardCount);
                });
            }

            function writeBug(bugID, fromStatus, targetStatus, bugResolution, bugPriority, bugSeverity, bugMilestone) {
                var dataObj = {
                    status: targetStatus,
                    resolution : "",
                    priority : "",
                    severity : "",
                    token : authObject.userToken,
                    comment : "",
                    target_milestone : ""
                };

                if (bugResolution !== "") {
                    dataObj.resolution = bugResolution;
                } else {
                    delete dataObj.resolution;
                }

                if (bugPriority !== "") {
                    dataObj.priority = bugPriority;
                } else {
                    delete dataObj.priority;
                }

                if (bugMilestone !== "") {
                    dataObj.target_milestone = bugMilestone;
                } else {
                    delete dataObj.target_milestone;
                }

                if (bugSeverity !== "") {
                    dataObj.severity = bugSeverity;
                } else {
                    delete dataObj.severity;
                }

                var bugComment = { body : "" };

                // TODO: Comment box popup
                if (shouldAutoComment) {
                    bugComment.body = "Auto-comment from bzKanban";
                }

                if (bugComment.body !== "") {
                    dataObj.comment = bugComment;
                } else {
                    delete dataObj.comment;
                }

                // TODO: maybe check if bugID != number
                httpPut("/rest/bug/" + bugID, dataObj, function() {
                    loadBoard();
                });
            }

            function scheduleCheckForUpdates() {
                window.setTimeout(function() {
                    loadCheckForUpdates();
                }, 600000);
            }

            function dragCardOver(ev) {
                ev.preventDefault();
            }

            function dragCardEnter(ev) {
                ev.preventDefault();

                var getCardEvData = ev.dataTransfer.getData("text");
                if (getCardEvData) {
                    var bugData = JSON.parse(getCardEvData);
                    if (bugData.status != ev.currentTarget.id) {
                        ev.currentTarget.classList.add("drag-card");
                    }
                }

                if (ev.target.classList.contains("drop-target")) {
                    ev.target.classList.add("drop-target-hover");
                }
            }

            function dragCardLeave(ev) {
                ev.currentTarget.classList.remove("drag-card");

                if (ev.target.classList.contains("drop-target")) {
                    ev.target.classList.remove("drop-target-hover");
                }
            }

            function dragCard(ev) {
                var fromStatus = ev.target.parentElement.id;

                // Disable pointer-events for all other cards so that we
                // can reliably detect when a card enters and leaves a column.
                var cards = document.querySelectorAll(".card");
                cards.forEach(function(card) {
                    if (card.id != ev.currentTarget.id) {
                        card.style.pointerEvents = "none";
                    }
                });

                var bugID = ev.currentTarget.dataset.bugId;
                var bugData = {"id": bugID, "status": fromStatus};
                ev.dataTransfer.setData("text", JSON.stringify(bugData));
            }

            function dragCardStart(ev) {
                columnTitle = ev.currentTarget.childNodes[0].childNodes[0].data;
                if (!(columnTitle == "UNCONFIRMED" || columnTitle == "VERIFIED")) {
                    showResolutions(document.getElementById("RESOLVED"));
                    showPriorities(document.getElementById(columnTitle));
                    showSeverities(document.getElementById(columnTitle));
                }
                showBacklog();
            }

            function dragCardEnd(ev) {
                columnTitle = ev.currentTarget.childNodes[0].childNodes[0].data;
                if (!(columnTitle == "UNCONFIRMED" || columnTitle == "VERIFIED")) {
                    hideResolutions(document.getElementById("RESOLVED"));
                    hidePriorities(document.getElementById(columnTitle));
                    hideSeverities(document.getElementById(columnTitle));
                }
                hideBacklog();
            }

            function dropCard(ev) {
                // Re-enable pointer events for all cards.
                var cards = document.querySelectorAll(".card");
                cards.forEach(function(card) {
                    card.style.pointerEvents = "auto";
                });

                ev.currentTarget.classList.remove("drag-card");

                ev.preventDefault();

                var bugData = JSON.parse(ev.dataTransfer.getData("text"));

                var targetStatus = ev.currentTarget.id;
                var targetResolution = "";
                var targetPriority = "";
                var targetSeverity = "";
                if (ev.target.classList.contains("resolution")) {
                    targetResolution = ev.target.id;
                } else if (ev.target.classList.contains("priority")) {
                    targetPriority = ev.target.id;
                } else if (ev.target.classList.contains("severity")) {
                    targetSeverity = ev.target.id;
                }

                writeBug(bugData.id, bugData.status, targetStatus, targetResolution, targetPriority, targetSeverity, "");
            }

            function dropBacklog(ev) {
                if (ev.target.classList.contains("drop-target")) {
                    ev.target.classList.remove("drop-target-hover");
                }
                ev.preventDefault();

                var bugData = JSON.parse(ev.dataTransfer.getData("text"));

                var targetStatus = "CONFIRMED";
                var targetResolution = "";
                var targetPriority = defaultPriority;
                var targetSeverity = "";

                writeBug(bugData.id, bugData.status, targetStatus, targetResolution, targetPriority, targetSeverity, defaultMilestone);

            }

            function showResolutions(elem) {
                var resolutions = elem.querySelectorAll(".resolutions");
                resolutions.forEach(function(res) {
                    res.hidden = false;
                });
                hideCards(elem);
            }

            function hideResolutions(elem) {
                var resolutions = elem.querySelectorAll(".resolutions");
                resolutions.forEach(function(resolution) {
                    resolution.hidden = true;
                });
                showCards(elem);
            }

            function showPriorities(elem) {
                var priorities = elem.querySelectorAll(".priorities");
                priorities.forEach(function(priority) {
                    priority.hidden = false;
                });
                hideCards(elem);
            }

            function hidePriorities(elem) {
                var priorities = elem.querySelectorAll(".priorities");
                priorities.forEach(function(priority) {
                    priority.hidden = true;
                });
                showCards(elem);
            }

            function showSeverities(elem) {
                var severities = elem.querySelectorAll(".severities");
                severities.forEach(function(severity) {
                    severity.hidden = false;
                });
                hideCards(elem);
            }

            function hideSeverities(elem) {
                var severities = elem.querySelectorAll(".severities");
                severities.forEach(function(severity) {
                    severity.hidden = true;
                });
                showCards(elem);
            }

            function showCards(elem) {
                var cards = elem.querySelectorAll(".card");
                cards.forEach(function(card) {
                    card.style.display = "block";
                });
            }

            function hideCards(elem) {
                var cards = elem.querySelectorAll(".card");
                cards.forEach(function(card) {
                    card.style.display = "none";
                });
            }

            function showBacklog() {
                document.getElementById("textBacklog").style.display = "inline-block";
            }

            function hideBacklog() {
                document.getElementById("textBacklog").style.display = "none";
            }

            function isTrue(string) {
                return (string === 'true');
            }

            function removeChildren(elem) {
                while (elem.firstChild) {
                    elem.removeChild(elem.firstChild);
                }
            }

            function getPictureSrc(email) {
                var hash = CryptoJS.MD5(email);
                var hashString = hash.toString(CryptoJS.enc.Base64);

                if (hashString !== "") {
                    return ('https://www.gravatar.com/avatar/' + hashString + '?s=20&d=blank');
                }
            }

            function hidePicture(pictureobject) {
                pictureobject.style.display = "none";
            }

            function updateAddressBar() {
                var currentURL = location.href;
                var newURL = currentURL.split("?")[0]; // trim off params
                newURL += "?product=" + bzProduct;
                newURL += "&milestone=" + bzProductMilestone;
                newURL += "&assignee=" + bzAssignedTo;
                newURL += "&gravatar=" + userGravatar;
                newURL += "&comments=" + shouldLoadComments;
                newURL += "&autocomment=" + shouldAutoComment;
                newURL += "&autorefresh=" + shouldAutoRefresh;
                newURL += "&site=" + bzSiteUrl;

                history.pushState({}, '', newURL);
            }

            // Register event handlers

            // When the user changes the Product drop down
            document.getElementById("textProduct").addEventListener("input", function() {
                bzProduct = document.getElementById('textProduct').value;

                // Disable Milestones until it's refreshed
                document.getElementById("textMilestone").disabled = true;

                // Clear affected state.
                bzProductMilestone = "";
                bzAssignedTo = "";
                loadMilestonesList();
                clearAssigneesList();
                clearBoard();
                updateAddressBar();
                });

            // When the user changes the Milestone drop down
            document.getElementById("textMilestone").addEventListener("input", function() {
                bzProductMilestone = document.getElementById('textMilestone').value;

                // Clear affected state.
                bzAssignedTo = "";
                clearAssigneesList();

                // Hot load the board without a form submit.
                loadBoard();
                updateAddressBar();
                });

            // When the user changes the Assignee drop down
            document.getElementById("textAssignee").addEventListener("input", function() {
                bzAssignedTo = document.getElementById('textAssignee').value;
                updateAddressBar();
                var name = assignees.get(bzAssignedTo).real_name;
                filterByAssignee(name);
                });

            // When the user presses the Login button
            document.getElementById("btnSignIn").addEventListener("click", function() {
                showLoginForm();
                });

            // When the user presses the login Submit button
            document.getElementById("btnAuthSubmit").addEventListener("click", function() {
                var user = document.getElementById("textUsername").value;
                var password = document.getElementById("textPassword").value;
                doAuth(user, password);
                });

            // Background checking for updates to visible cards
            document.addEventListener("visibilitychange", function() {
                if (document.hidden) {
                    shouldCheckForUpdates = false;
                } else {
                    shouldCheckForUpdates = true;
                    loadCheckForUpdates();
                }
                });

            // When the user presses enter, in the Login password form
            document.getElementById("textPassword").addEventListener("keyup", function(event) {
                event.preventDefault();
                if (event.keyCode == 13) {
                    document.getElementById("btnAuthSubmit").click();
                }
                });

            // When the user clicks the New Bug button
            document.getElementById("btnCreate").addEventListener("click", function() {
                    if (isLoggedIn()) {
                        // Open the modal
                        document.getElementById('modalAddBug').style.display = "block";
                    } else {
                        // Open Bugzilla page
                        var product = document.getElementById("textProduct").value;
                        window.open(bzSiteUrl + "/enter_bug.cgi?product=" + product);
                    }
                });

            // When the user clicks on <span> (x), close the modal
            document.getElementsByClassName("modalClose")[0].onclick = function() {
                document.getElementById('modalAddBug').style.display = "none";
                };

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function(event) {
                if (event.target == document.getElementById('modalAddBug')) {
                    document.getElementById('modalAddBug').style.display = "none";
                }
                };

            // When the user clicks the modal Submit button
            document.getElementById("btnModalSubmit").addEventListener("click", function() {
                    var dataObj = {
                        product: bzProduct,
                        component: document.getElementById("textComponent").value,
                        summary: document.getElementById("textAddBugSummary").value,
                        description: document.getElementById("textAddBugDescription").value,
                        version: document.getElementById("textVersion").value,
                        // Bugzilla web CGI kicks in if opsys and platform default is blank
                        // doing code to detect through the browser.
                        // TODO: Write js detection code if blank is detected
                        op_sys: "ALL",
                        platform: "ALL",
                        target_milestone: bzProductMilestone
                    };

                    httpRequest("POST", "/rest/bug?token=" + authObject.userToken, dataObj, function() {
                        document.getElementById('modalAddBug').style.display = "none";
                        var componentList = document.getElementById("textComponent");
                        var versionList = document.getElementById("textVersion");

                        while (componentList.firstChild) {
                            componentList.removeChild(componentList.firstChild);
                        }
                        while (versionList.firstChild) {
                            versionList.removeChild(versionList.firstChild);
                        }
                        loadBoard();
                    });
                });

        </script>
    </body>
</html>
